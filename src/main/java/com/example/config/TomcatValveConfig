package com.example.config;

import org.apache.catalina.Engine;
import org.apache.catalina.Host;
import org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;

// NOTE: This config customizes the embedded Tomcat (Spring Boot).
@Configuration
public class TomcatValveConfig {

    @Bean
    TomcatServletWebServerFactory tomcatFactory() {
        TomcatServletWebServerFactory f = new TomcatServletWebServerFactory();
        // Add valves to engine/host/context pipelines to trace traversal.
        f.addContextCustomizers(ctx -> {
            Host host = (Host) ctx.getParent();
            Engine engine = (Engine) host.getParent();
            engine.getPipeline().addValve(new TraceValve("engine"));   // logs at Engine level
            host.getPipeline().addValve(new TraceValve("host"));       // logs at Host level
            ctx.getPipeline().addValve(new TraceValve("context"));     // logs at Context level
        });
        return f;
    }
}
